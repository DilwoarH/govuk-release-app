<% content_for :page_title, @application.name %>

<div class="release-header">
  <%= render "govuk_publishing_components/components/breadcrumbs", {
    breadcrumbs: [
      root_crumb,
      {
        title: @application.name,
      }
    ]
  } %>
  <%= render "govuk_publishing_components/components/title", {
    title: "Deploy #{@application.name}",
    context: @application.shortname,
    margin_bottom: 0
  } %>
  <%= render partial: "provider_badge", locals: { application: @application } %>
</div>

<%= render "components/tabs", {
  tabs: [
    {
      href: @application,
      label: "Deploy status",
      active: true,
    },
    {
      href: edit_application_path(@application),
      label: "Edit",
    },
    {
      href: application_deployments_path(@application),
      label: "Recent deployments",
    },
    {
      href: stats_application_path(@application),
      label: "Stats",
    }
  ]
} %>

<% if @application.archived %>
  <%= render "govuk_publishing_components/components/notice", {
    title: "This application has been marked as archived.",
    margin_bottom: 4,
  } %>
<% end %>

<%= render 'status_notes', application: @application %>

<%= render "govuk_publishing_components/components/heading", {
  text: "Commit log",
  heading_level: 2,
  margin_bottom: 4,
} %>

<% if @github_available %>
  <table class="table table-striped table-bordered table-hover">
    <thead>
      <tr class="table-header">
        <th>Deployed to</th>
        <th>Tags</th>
        <th>Commit</th>
      </tr>
    </thead>
    <tbody>
      <% @commits.each do |commit| %>
        <tr>
          <% if tags = @tags_by_commit[commit[:sha]] %>
            <td>
              <% tags.each do |tag| %>
                <% if deployments = @latest_deploy_to_each_environment_by_version[tag[:name]] %>
                  <% deployments.each do |deployment| %>
                  <p class="deployment <%= 'production' if ['production', 'production-aws'].include?(deployment.environment) %>">
                    <strong class="label label-default env"><%= deployment.environment.humanize %></strong>
                    <span class="rm">at</span>
                    <%= time_tag(deployment.created_at, human_datetime(deployment.created_at)) %>
                  </p>
                  <% end %>
                <% end %>
              <% end %>
            </td>
            <td>
              <% tags.each do |tag| %>
                <span class="release-tag"><a href="<%= deploy_application_path(@application) %>?tag=<%= tag[:name] %>"><%= tag[:name] %></a></span>
              <% end %>
            </td>
          <% else %>
            <td></td>
            <td></td>
          <% end %>
          <td>
            <%= commit[:commit][:message].split(/\n/)[0] %>
            <% if commit[:commit][:author] %>
            <span class="author">
              <%= commit[:commit][:author][:name] %>
            </span>
            <% end %>
            <small>
            <%= link_to commit[:sha][0..8], "#{@application.repo_url}/commit/#{commit[:sha]}", target: "_blank", class: "commit-hash pull-right" %>
            </small>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <%= render "govuk_publishing_components/components/govspeak", {
  } do %>
    <div class="application-notice help-notice">
    <p>Couldn't get data from GitHub:</p>
    <p><%= @github_error %></p>
  </div>
  <% end %>
<% end %>

<%= render "govuk_publishing_components/components/heading", {
  text: "What's where?",
  heading_level: 2,
  margin_bottom: 4,
} %>

<%= render "govuk_publishing_components/components/button", {
  text: "Record a missing deployment",
  href: new_application_deployment_path(@application),
  margin_bottom: true
} %>

<table class="table table-striped table-bordered table-hover">
  <thead class="table-header">
    <tr>
      <th>Environment</th>
      <th>Version</th>
      <th>Previous version</th>
    </tr>
  </thead>
  <tbody>
    <% @application.latest_deploy_to_each_environment.each do |environment, deployment| %>
      <tr>
        <td><%= environment.humanize %></td>
        <td>
          <%= github_tag_link_to(@application, deployment.version) %>
          at
          <%= human_datetime(deployment.created_at) %>
        </td>
        <td>
          <% if deployment.previous_deployment %>
            <%= github_tag_link_to(@application, deployment.previous_deployment.version) %>
            at
            <%= human_datetime(deployment.previous_deployment.created_at) %>
          <% else %>
            N/A
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
